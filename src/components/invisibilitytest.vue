<template>
    <!-- InvisibilityTest Resolver -->
    <div class="invisibilitytest-section mb-4">
        <div class="jn-title2">
            <h2 id="InvisibilityTest" :class="{ 'mobile-h2': isMobile }">🫣 {{ $t('invisibilitytest.Title') }}</h2>
        </div>
        <div class="text-secondary">
            <p>{{ $t('invisibilitytest.Note') }}</p>
        </div>
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card jn-card" :class="{ 'dark-mode dark-mode-border': isDarkMode }">
                    <div class="card-body">
                        <div class="col-12 col-md-auto mt-2">
                            <span>{{ $t('invisibilitytest.Note2') }}</span>
                        </div>

                        <div class="input-group mb-2 mt-3">

                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox" value=""
                                    aria-label="Checkbox for Collecting datas" name="collectingDatas"
                                    id="collectingDatas" v-model="isAgreed">
                                <label for="collectingDatas">&nbsp;{{ $t('invisibilitytest.agreement') }}</label>
                            </div>

                            <button class="btn btn-primary" @click="onSubmit"
                                :disabled="checkingStatus === 'running' || !isAgreed">
                                <span v-if="checkingStatus === 'idle'">{{
                                    $t('invisibilitytest.Run') }}</span>
                                <span v-if="checkingStatus === 'running'" class="spinner-grow spinner-grow-sm"
                                    aria-hidden="true"></span>
                            </button>

                        </div>

                        <div class="jn-placeholder">
                            <p v-if="errorMsg" class="text-danger">{{ errorMsg }}</p>
                        </div>

                        <!-- Results Table -->
                        <Transition name="jn-it-slide-fade">
                            <div class="alert alert-success" role="alert" v-if="Object.keys(testResults).length > 0">

                                <p>{{ $t('invisibilitytest.yourIP') }}: <strong>{{ testResults.ip }}</strong>.</p>

                                <p><i class="bi bi-lock-fill"></i> {{ $t('invisibilitytest.proxyScore') }}:
                                    {{ testResults.score.proxy }}/100.
                                </p>
                                <p><i class="bi bi-shield-lock-fill"></i> {{ $t('invisibilitytest.VPNScore') }}:
                                    {{ testResults.score.vpn }}/100.
                                </p>

                                <span v-if="testResults.score.proxy >= 50">
                                    <strong>{{ $t('invisibilitytest.isProxy') }}&nbsp;</strong>
                                </span>
                                <span v-else>
                                    {{ $t('invisibilitytest.notProxy') }}&nbsp;
                                </span>

                                <span v-if="testResults.score.vpn >= 50">
                                    <strong>{{ $t('invisibilitytest.isVPN') }}</strong>
                                </span>
                                <span v-else>
                                    {{ $t('invisibilitytest.notVPN') }}
                                </span>
                            </div>
                        </Transition>
                        <Transition name="slide-fade">
                            <div class="table-responsive text-nowrap" v-if="Object.keys(testResults).length > 0">
                                <table class="table table-hover" :class="{ 'table-dark': isDarkMode }">
                                    <thead>
                                        <tr>
                                            <th scope="col">{{ $t('invisibilitytest.itemName') }}</th>
                                            <th scope="col">{{ $t('invisibilitytest.itemProxyResult') }}</th>
                                            <th scope="col">{{ $t('invisibilitytest.itemComment') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        <!--IP 黑名单-->
                                        <tr>
                                            <td class="jn-table-col">{{ $t('invisibilitytest.blocklist.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.blocklist.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.blocklist.proxy">{{
                                                    $t('invisibilitytest.blocklist.proxy') }}</span>
                                                <span v-else>{{ $t('invisibilitytest.blocklist.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!--Header 判断-->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.headers.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.headers.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.headers.proxy">{{
                                                    $t('invisibilitytest.headers.proxy') }}</span>
                                                <span v-else>{{ $t('invisibilitytest.headers.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- 数据中心 判断 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.datacenter.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.datacenter.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.datacenter.proxy">
                                                    {{ $t('invisibilitytest.datacenter.proxy') }}
                                                    <strong>{{ testResults.datacenter.hosting }}</strong>
                                                </span>
                                                <span v-else>{{ $t('invisibilitytest.datacenter.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- TCP 指纹判断 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.tcp.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.tcp.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.tcp.proxy">
                                                    {{ $t('invisibilitytest.tcp.proxy') }}
                                                    <br />
                                                    {{ $t('invisibilitytest.tcp.computer') }}
                                                    <strong>{{ testResults.tcp.clientos }}</strong>.

                                                    {{ $t('invisibilitytest.tcp.server') }}
                                                    <strong>{{ testResults.tcp.ipos }}</strong>

                                                </span>
                                                <span v-else>{{ $t('invisibilitytest.tcp.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- 时区差异 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.timezone.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.timezone.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.timezone.proxy">
                                                    {{ $t('invisibilitytest.timezone.proxy') }}
                                                    <br />
                                                    {{ $t('invisibilitytest.timezone.computer') }}
                                                    <strong>{{ testResults.timezone.clienttimezone }}</strong>.
                                                    {{ $t('invisibilitytest.timezone.server') }}
                                                    <strong>{{ testResults.timezone.iptimezone }}</strong>
                                                </span>
                                                <span v-else>{{ $t('invisibilitytest.timezone.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- 网络解析 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.net.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.net.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.net.proxy">{{ $t('invisibilitytest.net.proxy')
                                                    }}</span>
                                                <span v-else>{{ $t('invisibilitytest.net.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- WebRTC 检测 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.webrtc.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.webrtc.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.webrtc.proxy">
                                                    {{ $t('invisibilitytest.webrtc.proxy') }}
                                                    <br />
                                                    {{ $t('invisibilitytest.webrtc.ipsAre') }}

                                                    <span v-for="item in testResults.webrtc.allips" :key="item"><strong>{{ item
                                                        }}</strong>, </span>
                                                    <strong>{{ testResults.webrtc.ip }}</strong>
                                                </span>
                                                <span v-else>{{ $t('invisibilitytest.webrtc.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- 流量分析 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.flow.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.flow.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.flow.proxy">{{ $t('invisibilitytest.flow.proxy')
                                                    }}</span>
                                                <span v-else>{{ $t('invisibilitytest.flow.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- 延迟分析 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.latency.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.latency.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.latency.proxy">
                                                    {{ $t('invisibilitytest.latency.proxy') }}
                                                    <br />
                                                    {{ $t('invisibilitytest.latency.fromTCP') }}
                                                    <strong>{{ testResults.latency.tcpTime }}ms</strong>,

                                                    {{ $t('invisibilitytest.latency.fromWS') }}
                                                    <strong>{{ testResults.latency.wsTime }}ms</strong>
                                                </span>
                                                <span v-else>{{ $t('invisibilitytest.latency.notProxy') }}</span>
                                            </td>
                                        </tr>

                                        <!-- 高延迟分析 -->
                                        <tr>
                                            <td>{{ $t('invisibilitytest.highlatency.title') }}</td>
                                            <td>
                                                <i class="bi"
                                                    :class="testResults.highlatency.proxy ? 'bi-x-circle-fill text-danger' : 'bi-check-circle-fill text-success'"></i>
                                            </td>
                                            <td class="opacity-75">
                                                <span v-if="testResults.highlatency.proxy">{{
                                                    $t('invisibilitytest.highlatency.proxy') }}</span>
                                                <span v-else>{{ $t('invisibilitytest.highlatency.notProxy') }}</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </Transition>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { ref, computed } from 'vue';
import { useStore } from 'vuex';

export default {
    name: 'InvisibilityTest',

    setup() {
        const store = useStore();
        const isDarkMode = computed(() => store.state.isDarkMode);
        const isMobile = computed(() => store.state.isMobile);

        return {
            isDarkMode,
            isMobile,
        };
    },

    data() {
        return {
            checkingStatus: 'idle',
            errorMsg: '',
            testResults: {},
            userID: '',
            isAgreed: false
        }
    },

    methods: {

        // 生成28位字符串
        generate28DigitString() {
            const unixTime = Date.now().toString();
            const fixedString = "jason5ng32";
            const neededUnixTimeLength = 13;
            const remainingLength = 28 - fixedString.length - neededUnixTimeLength;
            const randomString = Math.random().toString(36).substring(2, 2 + remainingLength);
            return unixTime.substring(0, neededUnixTimeLength) + fixedString + randomString;
        },

        // IPv4 格式验证
        validateIPv4(ip) {
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            return ipv4Regex.test(ip);
        },

        // 加载测试脚本
        loadScript() {
            const script = document.createElement('script');
            script.src = `https://proxydetectjs.ipcheck.ing/?pdKey=${import.meta.env.VITE_INVISIBILITY_TEST_KEY}&pdVal=${this.userID}`;
            script.async = true;
            script.setAttribute('data-tag', 'invisibilityTestScript');
            script.onload = () => {
                // console.log('Script loaded successfully');
            };
            script.onerror = (error) => {
                console.error('Script load error:', error);
            };
            document.head.appendChild(script);
        },

        // 移除测试脚本
        removeScript() {
            const scripts = document.querySelectorAll('script[data-tag="invisibilityTestScript"]');
            scripts.forEach(script => script.remove());
        },

        // 提交查询
        onSubmit() {
            this.checkingStatus = 'running';
            this.userID = this.generate28DigitString();
            this.$trackEvent('Section', 'StartClick', 'InvisibilityTest');
            this.errorMsg = '';
            this.testResults = {};
            this.loadScript();

            // 初始调用 getResult 延迟 8 秒
            setTimeout(() => {
                this.getResult(this.userID, 0);
            }, 6000);
        },

        // 获取测试结果
        async getResult(userID, retryCount = 0) {
            try {
                const response = await fetch(`/api/invisibility?id=${userID}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // 检查并重试
                if (data.message === "Data not found" && retryCount < 3) {
                    console.log(`Data not found, retrying... (${retryCount + 1})`);
                    setTimeout(() => {
                        this.getResult(userID, retryCount + 1);
                    }, 4000); // 4 秒后重试
                    return;
                }
                this.testResults = this.processResults(data);
            } catch (error) {
                console.error('Error fetching InvisibilityTest results:', error);
                if (retryCount < 3) {
                    setTimeout(() => {
                        this.getResult(userID, retryCount + 1);
                    }, 4000);
                } else {
                    this.errorMsg = this.$t('invisibilitytest.fetchError');
                }
            } finally {
                this.removeScript();
                this.checkingStatus = 'idle';
            }
        },

        // 处理测试结果
        processResults(data) {
            let ip = data.ip;

            // 分数
            let score = {};
            score.proxy = data.proxy.score ? data.proxy.score : 0;
            score.vpn = data.vpn.score ? ((data.vpn.score / 55) * 100).toFixed(0) : 0;

            // 是否在黑名单
            let blocklist = {};
            blocklist.proxy = data.tests.blocklist ? data.tests.blocklist.is_proxy : false;
            blocklist.vpn = data.tests.blocklist ? data.tests.blocklist.is_vpn : false;

            // Header 判断
            let headers = {};
            headers.proxy = data.tests.headers ? data.tests.headers.is_proxy : false;

            // 数据中心判断
            let datacenter = {};
            datacenter.proxy = data.tests.datacenter ? data.tests.datacenter.is_proxy : false;
            datacenter.vpn = data.tests.datacenter ? data.tests.datacenter.is_vpn : null;
            datacenter.hosting = data.tests.datacenter ? data.tests.datacenter.info.company.name : null;

            // TCP 指纹判断
            let tcp = {};
            tcp.proxy = data.tests.tcpip_fp ? data.tests.tcpip_fp.is_proxy : false;
            tcp.ipos = data.tests.tcpip_fp ? data.tests.tcpip_fp.info.tcpIpHighestOs : null;
            tcp.clientos = data.tests.tcpip_fp ? data.tests.tcpip_fp.info.userAgentOs : null;

            // 时区判断
            let timezone = {};
            timezone.proxy = data.tests.timezone ? data.tests.timezone.is_proxy : false;
            timezone.vpn = data.tests.timezone ? data.tests.timezone.is_vpn : null;
            timezone.iptimezone = data.tests.timezone ? data.tests.timezone.info.ipTimeData.timezone : null;
            timezone.clienttimezone = data.tests.timezone ? data.tests.timezone.info.clientTimeData.time_zone : null;
            timezone.delta = data.tests.timezone ? data.tests.timezone.info.isProxyByTimeDelta.delta : null;
            timezone.isSame = timezone.clienttimezone === timezone.iptimezone ? true : false;

            // 网络解析判断
            let net = {};
            net.proxy = data.tests.net ? data.tests.net.is_proxy : false;

            // WebRTC 判断
            let webrtc = {};
            webrtc.proxy = data.tests.webrtc ? data.tests.webrtc.is_proxy : false;
            webrtc.allips = data.tests.webrtc ? data.tests.webrtc.info.allIps ? data.tests.webrtc.info.allIps : null : null;

            // 使用 validateIPv4 过滤 webrtc.allips 数组中的非 IPv4 地址
            webrtc.allips = webrtc.allips ? webrtc.allips.filter(ip => this.validateIPv4(ip)) : null;

            webrtc.ip = data.tests.webrtc ? data.tests.webrtc.info.ip ? data.tests.webrtc.info.ip : null : null;

            // 流量特征判断
            let flow = {};
            flow.proxy = data.tests.flow_pattern ? data.tests.flow_pattern.is_proxy : false;

            // 延迟判断
            let latency = {};
            latency.proxy = data.tests.latency ? data.tests.latency.is_proxy : false;
            latency.tcpTime = data.tests.latency ? data.tests.latency.info.tcpIpStats.min : null;
            latency.wsTime = data.tests.latency ? data.tests.latency.info.wsLatencyStats.min : null;

            // 高延迟判断
            let highlatency = {};
            highlatency.proxy = data.tests.high_latencies ? (data.tests.high_latencies.is_vpn || data.tests.high_latencies.is_proxy) ? true : false : false;

            return {
                ip,
                score,
                blocklist,
                headers,
                datacenter,
                tcp,
                timezone,
                net,
                webrtc,
                flow,
                latency,
                highlatency
            };
        },
    },
};
</script>

<style scoped>
.jn-placeholder {
    height: 16pt;
}

.jn-table-col {
    min-width: 120pt;
}

.jn-circle {
    width: 80pt;
    height: 80pt;
    border-radius: 50%;
    display: inline-block;
}

.jn-it-slide-fade-enter-active {
    transition: all 0.5s ease-in;
}

.jn-it-slide-fade-leave-active {
    transition: all 0.5s ease-out;
}

.jn-it-slide-fade-enter-from,
.jn-it-slide-fade-leave-to {
    transform: translateY(20px);
    opacity: 0;
}
</style>
